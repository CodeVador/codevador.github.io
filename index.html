<!doctype html>
<!--
    Application to decode FST files and convert them to ASCII.
-->

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Software to decode FST files and convert them to ASCII.">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>FST Decoder</title>
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
    <link rel="manifest" href="./manifest.json">
    <script>
        // Add a global error event listener early on in the page load, to help ensure that browsers
        // which don't support specific functionality still end up displaying a meaningful message.
        window.addEventListener('error', function (error) {
            if (LogActivity && LogActivity.setError) {
                console.error(error);
                LogActivity.clearError();
                LogActivity.setError(error.message + ' (Your browser may not support this feature.)');
                error.preventDefault();
            }
        });
    </script>
</head>

<body>
    <!--Service Worker-->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service worker registered!'))
                    .catch(err => console.log('Service worker error:' + err));
                // Startup functions.
            });
        }
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>

    <!--Layout-->
    <form onsubmit="return false;" style="padding: 5px;">
        <!--Header-->
        <div class="card bg-dark text-white">
            <div class="card-header">
                FST Decoder v0.0.1
            </div>
        </div>
        <!--Busy-->
        <div id="divBusy" class="card" hidden>
            <div class="card-header">
                Please wait <label id="lblProgress"></label>...
            </div>
            <div class="card-body">
                <div id="divProgressBar" class="progress" hidden>
                    <div id="progressBar" class="progress-bar">0%</div>
                </div>
            </div>
        </div>
        <!--Not busy-->
        <div id="divNotBusy">
            <!--Error top-->
            <div id="divError" class="card text-danger" hidden>
                <div class="card-header">
                    Error:
                </div>
                <div class="card-body">
                    <label id="lblError">N/A</label>
                </div>
            </div>
            <!--Convert-->
            <div class="card">
                <div class="card-header">
                    <a class="btn btn-secondary" data-bs-toggle="collapse" href="#collapseMenu">
                        Import FST job file
                    </a>
                </div>
                <div id="collapseMenu" class="collapse">
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="file" class="form-control" id="fileOpenJob" aria-describedby=""
                                aria-label="Upload" accept=".FST">
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="button" id="btnConvert" class="btn btn-primary">Convert to ASCII</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!--Common Script-->
    <script>

        //#region Layout definitions and functions.

        let divBusy = document.querySelector('#divBusy');
        let divProgressBar = document.querySelector('#divProgressBar');
        let progressBar = document.querySelector('#progressBar');
        let divNotBusy = document.querySelector('#divNotBusy');
        let divError = document.querySelector('#divError');
        let btnConvert = document.querySelector('#btnConvert');
        let btnCreate = document.querySelector('#btnCreate');
        let lblProgress = document.querySelector('#lblProgress');
        let lblError = document.querySelector('#lblError');

        btnConvert.addEventListener('click', async function (event) {
            event.stopPropagation();
            event.preventDefault();

            await performConvert();
        });

        function divBusyShow(enable, showProgress) {
            if (enable) {
                if (showProgress) {
                    progressBarPercentage('0%');
                    divProgressBar.removeAttribute('hidden');
                } else {
                    divProgressBar.setAttribute('hidden', true);
                }
                divBusy.removeAttribute('hidden');
                divNotBusy.setAttribute('hidden', true);
            } else {
                divBusy.setAttribute('hidden', true);
                divNotBusy.removeAttribute('hidden');
            }
        }
        function divErrorShow(enable) {
            if (enable) {
                divError.removeAttribute('hidden');
            } else {
                divError.setAttribute('hidden', true);
            }
        }
        function progressBarPercentage(value) {
            progressBar.innerHTML = value;
            progressBar.style.width = value;
        }
        function lblProgressText(value) {
            lblProgress.innerHTML = value;
        }
        function lblErrorText(value) {
            lblError.innerHTML += value;
        }

        //#endregion Layout definitions and functions.

        //#region Code.
        const FILE_HEADER_SIZE = 2048;

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function addZero(x, n) {
            while (x.toString().length < n) {
                x = "0" + x;
            }
            return x;
        }

        //#endregion Code.

    </script>

    <!--Log definitions-->
    <script>
        let LogActivity = {
            log: function () {

                let d = new Date();
                let h = addZero(d.getHours(), 2);
                let m = addZero(d.getMinutes(), 2);
                let s = addZero(d.getSeconds(), 2);
                let ms = addZero(d.getMilliseconds(), 3);

                let line = '(' + h + ":" + m + ":" + s + ":" + ms + ') ' + Array.prototype.slice.call(arguments).map(function (argument) {
                    return typeof argument === 'string' ? argument : JSON.stringify(argument);
                }).join(' ');

                console.log(line + '\n');
            },

            clearError: function () {
                lblError.innerHTML = '';
                divErrorShow(false);
            },
            setError: function (err) {
                lblErrorText(err + '\n');
                divErrorShow(true);
                window.scrollTo(0, 0);
            },
        };

        log = LogActivity.log;
    </script>
</body>

</html>